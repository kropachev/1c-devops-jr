# –í–≤–µ–¥–µ–Ω–∏–µ

–≠—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–º–æ–∂–µ—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å CI –∫–æ–Ω–≤–µ–π–µ—Ä –¥–ª—è 1–° —Å –Ω—É–ª—è –Ω–∞ –æ–¥–Ω–æ–π Ubuntu –º–∞—à–∏–Ω–µ.  
üí° –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª Kubernetes –∏ CI/CD.
 
–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —É –≤–∞—Å –±—É–¥–µ—Ç:

* "–õ–µ–≥–∫–∏–π" Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä K3s
* Jenkins —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏
* SonarQube –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–∞—á–µ—Å—Ç–≤–∞
* Docker Registry –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤
* Portainer –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Kubernetes

## –ü–æ—á–µ–º—É Kubernetes

Swarm-–ø–ª–∞–≥–∏–Ω Jenkins –±–æ–ª—å—à–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –∞ Kubernetes  —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è.  
–ü–æ–∫–∞ —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å —ç—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –±—ã–ª –≤—ã–ø—É—â–µ–Ω, –∏–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω, –Ω–æ–≤—ã–π –ø–ª–∞–≥–∏–Ω - https://plugins.jenkins.io/swarm-agents-cloud/. –ù–æ –ø–æ–±–µ–¥–∏–ª–∏ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å, —Ç—è–≥–∞ –∫ –Ω–æ–≤–æ–º—É –∏ –≤–æ–æ–±—â–µ.  
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –±—É–¥–µ–º K3s - –æ–±–ª–µ–≥—á–µ–Ω–Ω–∞—è —Å–±–æ—Ä–∫–∞ Kubernetes, –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.

## DNS –∏ HTTPS, –≤–∞–∂–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ

–ù–∞ —Ç–µ—Å—Ç–æ–≤–æ–º —Å—Ç–µ–Ω–¥–µ –º—ã –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º CI –ø–æ HTTPS, –ø—Ä—è–º–æ –∫–∞–∫ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –ø—Ä–æ–¥–∞, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ CA, –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –∫–æ–Ω—Ç—É—Ä–µ, –¥–ª—è –ª–∏—á–Ω—ã—Ö —Ü–µ–ª–µ–π, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –º—ã –≤—ã–ø—É—Å—Ç–∏–º —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π Root CA.

> ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ: –≤—Å—è –¥–∞–ª—å–Ω–µ–π—à–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç, —á—Ç–æ –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º –±—É–¥–µ—Ç –æ—Å—É—â–µ—Å—Ç–≤–ª—è—Ç—å—Å—è –ø–æ –¥–æ–º–µ–Ω–Ω—ã–º –∏–º–µ–Ω–∞–º, –∞ –Ω–µ –ø–æ IP.  
–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π DNS Kubernetes (CoreDNS) —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ –∏ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Ä–µ–∑–æ–ª–≤–∏–Ω–≥–µ –∏–º–µ–Ω –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.  
–°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –¥–æ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å—Ç–µ–Ω–¥–∞ (–≤ –ø—Ä–∏–º–µ—Ä–µ - *.onecci.lan) –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º DNS-—Å–µ—Ä–≤–µ—Ä–µ —Å–µ—Ç–∏ (–∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ, —Å–º. —Ä–∞–∑–¥–µ–ª **DNS –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞**).

### –±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è

- –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º k3s
- –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Traefik (Ingress-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ k3s)
- –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ –¥–æ–º–µ–Ω–Ω—ã–º –∏–º–µ–Ω–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä jenkins.onecci.lan)
- –æ–¥–∏–Ω —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–¥–ø–∏—Å–∞–Ω —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º Root CA
- Root CA —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –Ω–∞ —É–∑–ª–∞—Ö k3s (–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –º–∞—à–∏–Ω–∞—Ö)
- —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Kubernetes Secret
- TLS –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –Ω–∞ Ingress (Traefik), –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ HTTP –∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏.
- –í –±—Ä–∞—É–∑–µ—Ä–µ –±—É–¥–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ–¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ (–∏–ª–∏ –Ω–µ –±—É–¥–µ—Ç, –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏–º Root CA)

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –í –±—Ä–∞—É–∑–µ—Ä–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ `https://jenkins.onecci.lan`
2. TLS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å Traefik:
   - Traefik –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏–∑ Kubernetes Secret;
   - –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ SAN –∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞.
3. Traefik —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç HTTPS –∏ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å: `HTTP -> Service -> Pod`
4. Jenkins (–∏–ª–∏ –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å) –ø–æ–ª—É—á–∞–µ—Ç –æ–±—ã—á–Ω—ã–π HTTP-–∑–∞–ø—Ä–æ—Å.

### –ß—Ç–æ –º—ã –ø–æ–ª—É—á–∏–º
- –æ–¥–∏–Ω TLS-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–∞ –≤–µ—Å—å CI-–∫–æ–Ω—Ç—É—Ä;
- –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç TLS-–Ω–∞—Å—Ç—Ä–æ–µ–∫ (–Ω—É, –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞);
- —É–ø—Ä–æ—â–∞–µ—Ç—Å—è —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤;
- –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∞ –∫ –ø—Ä–æ–¥—É.

## DNS –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞

–ü–µ—Ä–µ–¥ —Ä–∞–±–æ—Ç–æ–π —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π Ingress –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π DNS-—Ä–µ–∑–æ–ª–≤–∏–Ω–≥ –∏–º–µ–Ω —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ IP –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã —Å Kubernetes.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS –≤ OpenWRT

–ù–∞ —Ä–æ—É—Ç–µ—Ä–∞—Ö OpenWRT —ç—Ç–æ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ **Network** - **DHCP and DNS** - **General**, –≤ –ø–æ–ª–µ **Address** –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–µ–∑–æ–ª–≤–∏–Ω–≥–∞:
- `/onecci.lan/192.168.1.50` - –¥–ª—è ipv4
- `/onecci.lan/::ffff:192.168.1.50` - –¥–ª—è ipv6 (`::ffff:` –ø–ª—é IP v4)  

–í–æ–∑–º–æ–∂–Ω–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–æ—É—Ç–µ—Ä, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å.

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É 

```bash
nslookup onecci.lan
nslookup subtest.onecci.lan
```
–ò –∏–º—è —Å–µ—Ä–≤–µ—Ä–∞ –∏ –≤—Å–µ –ø–æ–¥–¥–æ–º–µ–Ω—ã –¥–æ–ª–∂–Ω—ã —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞.